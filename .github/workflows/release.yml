name: Create Release Assets

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release version
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create assets directory structure
        run: |
          mkdir -p release-assets

      - name: Copy release assets
        run: |
          # Copy all assets directory (includes logos, colors, fonts, templates, guidelines)
          cp -r assets release-assets/
          
          # Copy root level documentation files
          cp README.md release-assets/
          cp LICENSE release-assets/

      - name: Create ZIP archives
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create complete package ZIP
          cd release-assets
          zip -r ../kieks-me-assets-v${VERSION}.zip .
          cd ..
          
          # Create logos-only ZIP
          mkdir -p release-assets-logos
          cp -r assets/logos release-assets-logos/logos
          cp assets/favicon.svg release-assets-logos/ 2>/dev/null || true
          cd release-assets-logos
          zip -r ../kieks-me-logos-v${VERSION}.zip .
          cd ..
          
          # Create colors-only ZIP
          mkdir -p release-assets-colors
          cp -r assets/colors release-assets-colors/colors
          cd release-assets-colors
          zip -r ../kieks-me-colors-v${VERSION}.zip .
          cd ..
          
          # Create fonts-only ZIP
          mkdir -p release-assets-fonts
          cp -r assets/fonts release-assets-fonts/fonts
          cd release-assets-fonts
          zip -r ../kieks-me-fonts-v${VERSION}.zip .
          cd ..
          
          # Create icons-only ZIP
          mkdir -p release-assets-icons
          cp -r assets/icons release-assets-icons/icons 2>/dev/null || true
          cd release-assets-icons
          if [ -d icons ] && [ "$(ls -A icons)" ]; then
            zip -r ../kieks-me-icons-v${VERSION}.zip .
          fi
          cd ..

      - name: Generate Release README
        id: readme
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%d")
          
          # Extract changelog section for current version
          if [ -f CHANGELOG.md ]; then
            # Extract the changelog entry for this version (from ## [VERSION] to next ## or end of file)
            # Use awk to extract between version headers
            CHANGELOG_ENTRY=$(awk -v version="${VERSION}" '
              /^## \[/ { 
                if (found) exit
                if ($0 ~ "## \\[" version "\\]") {
                  found = 1
                  next
                }
              }
              found {
                if (/^## \[/) exit
                print
              }
            ' CHANGELOG.md)
            
            if [ -n "$CHANGELOG_ENTRY" ] && [ "$CHANGELOG_ENTRY" != "" ]; then
              # Convert changelog format to release notes format
              # Use a prominent header with visual separation
              CHANGELOG_SECTION=$'\n---\n\n'
              CHANGELOG_SECTION+="## âœ¨ What\'s New in v${VERSION}"$'\n\n'
              
              # Format the changelog entries - preserve structure but improve formatting
              CHANGELOG_SECTION+=$(echo "$CHANGELOG_ENTRY" | \
                sed 's/^\* \*\*\([^:]*\):\*\*/- **\1**:/' | \
                sed 's/^\* /  - /' | \
                sed 's/^### Features/### âœ¨ Features/' | \
                sed 's/^### Bug Fixes/### ðŸ› Bug Fixes/' | \
                sed 's/^### Miscellaneous Chores/### ðŸ”§ Miscellaneous Chores/')
              
              # Add spacing and visual separator at the end
              CHANGELOG_SECTION+=$'\n\n---\n'
              
              # Save to temp file for insertion
              echo "$CHANGELOG_SECTION" > /tmp/changelog_section.txt
            else
              echo "No changelog entry found for version ${VERSION}"
            fi
          else
            echo "CHANGELOG.md not found"
          fi
          
          # Replace placeholders in template
          sed -e "s/\${VERSION}/${VERSION}/g" \
              -e "s/\${RELEASE_DATE}/${RELEASE_DATE}/g" \
              RELEASE_README.md > /tmp/release_readme_temp.md
          
          # Replace CHANGELOG_SECTION placeholder
          if [ -f /tmp/changelog_section.txt ] && [ -s /tmp/changelog_section.txt ]; then
            # Use awk to insert changelog content
            awk '
              /\$\{CHANGELOG_SECTION\}/ {
                while ((getline line < "/tmp/changelog_section.txt") > 0) {
                  print line
                }
                close("/tmp/changelog_section.txt")
                next
              }
              { print }
            ' /tmp/release_readme_temp.md > RELEASE_README.md
          else
            # Remove placeholder if no changelog entry
            sed 's|\${CHANGELOG_SECTION}||g' /tmp/release_readme_temp.md > RELEASE_README.md
          fi
          
          echo "readme_path=RELEASE_README.md" >> $GITHUB_OUTPUT

      - name: Upload complete package ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-assets-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-assets-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload logos ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-logos-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-logos-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload colors ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-colors-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-colors-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload fonts ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-fonts-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-fonts-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Upload icons ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-icons-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-icons-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip
        continue-on-error: true

      - name: Update Release Notes
        run: |
          gh release edit ${{ github.event.release.tag_name }} \
            --repo ${{ github.repository }} \
            --notes-file RELEASE_README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
